@model BookingsViewModel
@{
    // --- Calendar Logic ---

    // Get the target month from the Controller
    var displayMonth = (DateTime)ViewBag.CalendarDate;

    var today = DateTime.Today;

    // Base all calculations on the 'displayMonth' from the controller
    var firstDayOfMonth = displayMonth; // It's already the 1st
    var daysInMonth = DateTime.DaysInMonth(displayMonth.Year, displayMonth.Month);

    // Calculate day offset
    int originalStartDayOffset = (int)firstDayOfMonth.DayOfWeek;
    int startDayOffset = (originalStartDayOffset == 0) ? 6 : originalStartDayOffset - 1;

    // Create dates for the navigation buttons
    var prevMonth = displayMonth.AddMonths(-1);
    var nextMonth = displayMonth.AddMonths(1);
}

<div class="container">
    <h1>@ViewBag.CurrentViewName</h1>

    <p>
        <a class="btn btn-secondary" asp-controller="Booking" asp-action="Create">Create New Booking</a>
    </p>

    <!-- Calendar Title -->
    <div class="calendar-nav">
        <a class="btn btn-outline-secondary" asp-action="Calendar" asp-route-year="@prevMonth.Year"
            asp-route-month="@prevMonth.Month">&laquo; Forrige</a>

        <h2 class="calendar-title">@firstDayOfMonth.ToString("MMMM yyyy")</h2>

        <a class="btn btn-outline-secondary" asp-action="Calendar" asp-route-year="@nextMonth.Year"
            asp-route-month="@nextMonth.Month">Neste &raquo;</a>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
        <div class="calendar-header">Man</div>
        <div class="calendar-header">Tir</div>
        <div class="calendar-header">Ons</div>
        <div class="calendar-header">Tor</div>
        <div class="calendar-header">Fre</div>
        <div class="calendar-header">Lør</div>
        <div class="calendar-header">Søn</div>

        <!-- Empty cells for padding at the start of the month -->
        @for (int i = 0; i < startDayOffset; i++)
        {
            <div class="day-cell empty"></div>
        }

        <!-- Day cells for each day in the month -->
        @for (int day = 1; day <= daysInMonth; day++)
        {
            var currentCellDate = new DateTime(displayMonth.Year, displayMonth.Month, day);
            var dayClass = (currentCellDate == today) ? "day-cell today" : "day-cell";

            // Find bookings for this specific day.
            var bookingsForThisDay = Model.Bookings.Where(b => b.Date.Date == currentCellDate.Date);

            <div class="@dayClass">
                <div class="day-number">@day</div>

                <div class="bookings-container">
                    @foreach (var booking in bookingsForThisDay)
                    {
                        <div class="booking-entry">
                            <strong>@booking.Description</strong>
                            <div class="booking-details">
                                <!-- "t" gives short time -->
                                @booking.Date.ToString("t") <br />
                                P: @booking.PatientId | E: @booking.EmployeeId
                            </div>
                            <div class="booking-actions">
                                <a asp-action="Update" asp-route-id="@booking.BookingId">Update</a>
                                <a asp-action="Delete" asp-route-id="@booking.BookingId">Delete</a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>


<style>
    .calendar-nav {
        display: flex;
        justify-content: space-around;
    }

    .calendar-title {
        text-align: center;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #ddd;
        border: 1px solid #ddd;
    }

    .calendar-header {
        font-weight: bold;
        text-align: center;
        padding: 10px 5px;
        background-color: #f4f4f4;
    }

    .day-cell {
        /* Each cell will be at least 100px tall */
        min-height: 120px;
        padding: 8px;
        background-color: #fff;
        /* Use flexbox to position day number at top and bookings below */
        display: flex;
        flex-direction: column;
    }

    .day-cell.empty {
        background-color: #f9f9f9;
    }

    .day-cell.today {
        background-color: #fffde7;
        /* Highlight for today */
    }

    .day-cell.today .day-number {
        font-weight: bold;
    }

    .day-number {
        font-size: 1.1em;
        font-weight: 500;
        margin-bottom: 5px;
    }

    .bookings-container {
        flex-grow: 1;
        /* Allows this container to fill the remaining space */
        overflow-y: auto;
        /* Adds scrollbar if many bookings */
    }

    .booking-entry {
        background-color: #eef7ff;
        border: 1px solid #cce5ff;
        border-radius: 4px;
        padding: 5px;
        margin-top: 5px;
        font-size: 0.85em;
    }

    .booking-details {
        font-size: 0.9em;
        color: #555;
        margin: 3px 0;
    }

    .booking-actions {
        font-size: 0.9em;
    }

    .booking-actions a {
        margin-right: 5px;
    }
</style>